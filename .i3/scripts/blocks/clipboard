#!/bin/bash

function clip() {
  local type="$1"
  local input="$2"
  if builtin command -v xsel > /dev/null 2>&1; then
    echo $input | xsel -i $type
  elif builtin command -v xclip > /dev/null 2>&1; then
    echo $input | xclip -i -selection ${type//-/}
  fi
}

function paste() {
  local type="$1"
  if builtin command -v xsel > /dev/null 2>&1; then
    xsel -o $type
  elif builtin command -v xclip > /dev/null 2>&1; then
    xclip -o ${type//-/}
  fi
}

if [[ $1 == "--primary" ]]; then
  TYPE=$1
elif [[ $1 == "--clipboard" ]]; then
  TYPE=$1
else
  echo "arg error"
  exit 1
fi

STATE_FILE="/tmp/.i3blocks-clipboard-$TYPE.tmp"

if [[ ! -f "$STATE_FILE" ]]; then
  echo "unhidden" > $STATE_FILE
fi

function toggle_mode() {
  if cat "$STATE_FILE" | grep -q "unhidden"; then
    echo "hidden" > $STATE_FILE
  else
    echo "unhidden" > $STATE_FILE
  fi
}

# Left click
if [[ "${BLOCK_BUTTON}" -eq 1 ]]; then
  toggle_mode
# Middle click
elif [[ "${BLOCK_BUTTON}" -eq 2 ]]; then
  clip "$TYPE" "---" > /dev/null
# Right click
elif [[ "${BLOCK_BUTTON}" -eq 3 ]]; then
  toggle_mode
fi

#COMMAND=$(echo "($(xsel -o $TYPE | grep -o '^.\{0,5\}' | sed -e 's/[^a-zA-Z0-9\-]/_/g'))")
COMMAND=$(echo "($(paste $TYPE | tr -d '\n' | sed -e 's/^[ ]*//g' | grep -o '^.\{0,5\}'))")

if cat "$STATE_FILE" | grep -q "unhidden"; then
  echo "$COMMAND"
else
  echo "hidden"
fi

